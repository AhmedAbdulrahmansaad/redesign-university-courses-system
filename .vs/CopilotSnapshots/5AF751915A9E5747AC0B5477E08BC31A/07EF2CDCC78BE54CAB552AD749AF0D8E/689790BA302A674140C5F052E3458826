import { createClient as createSupabaseClient, SupabaseClient } from '@supabase/supabase-js';
import { projectId, publicAnonKey } from './info';

// Prefer explicit Vite env vars, fall back to autogenerated info
const SUPABASE_URL = (import.meta.env.VITE_SUPABASE_URL as string) || (projectId ? `https://${projectId}.supabase.co` : '');
const SUPABASE_ANON_KEY = (import.meta.env.VITE_SUPABASE_ANON_KEY as string) || publicAnonKey || '';

if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  // Inform developers to set env vars; avoid crashing at import time
  // (Some tooling runs in environments without envs.)
  // Do not expose secrets in the repo.
  // eslint-disable-next-line no-console
  console.warn('[supabase] VITE_SUPABASE_URL or VITE_SUPABASE_ANON_KEY is not set. Set them in your .env file.');
}

// إنشاء Supabase client (singleton)
export const supabase: SupabaseClient = createSupabaseClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: true,
  },
});

// Export createClient factory for server-side usage or tests
export const createClient = (url?: string, key?: string) =>
  createSupabaseClient(url || SUPABASE_URL, key || SUPABASE_ANON_KEY);

// Export configuration
export const supabaseConfig = {
  url: SUPABASE_URL,
  anonKey: SUPABASE_ANON_KEY,
};
