import { createClient as createSupabaseClient, SupabaseClient } from '@supabase/supabase-js';
import { projectId, publicAnonKey } from './info';

// Prefer explicit Vite env vars, fall back to autogenerated info
const SUPABASE_URL = (import.meta.env.VITE_SUPABASE_URL as string) || (projectId ? `https://${projectId}.supabase.co` : '');
const SUPABASE_ANON_KEY = (import.meta.env.VITE_SUPABASE_ANON_KEY as string) || publicAnonKey || '';

if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  // Inform developers to set env vars; avoid crashing at import time
  // (Some tooling runs in environments without envs.)
  // Do not expose secrets in the repo.
  // eslint-disable-next-line no-console
  console.warn('[supabase] VITE_SUPABASE_URL or VITE_SUPABASE_ANON_KEY is not set. Set them in your .env file.');
}

// إنشاء Supabase client (singleton)
// Create the client only when both URL and ANON key are available.
// This avoids creating a client with empty values during tooling or in environments
// where env vars are not set (e.g. some CI tasks).
export const supabase: SupabaseClient | null =
  SUPABASE_URL && SUPABASE_ANON_KEY
    ? createSupabaseClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          autoRefreshToken: true,
          persistSession: true,
          detectSessionInUrl: true,
        },
      })
    : null;

// Export createClient factory for server-side usage or tests
export const createClient = (url?: string, key?: string): SupabaseClient => {
  const finalUrl = url || SUPABASE_URL;
  const finalKey = key || SUPABASE_ANON_KEY;

  if (!finalUrl || !finalKey) {
    throw new Error(
      '[supabase] Cannot create client: SUPABASE_URL or SUPABASE_ANON_KEY is not set. Provide url and key or set env vars.'
    );
  }

  return createSupabaseClient(finalUrl, finalKey);
};

// Export configuration
export const supabaseConfig = {
  url: SUPABASE_URL,
  anonKey: SUPABASE_ANON_KEY,
};
