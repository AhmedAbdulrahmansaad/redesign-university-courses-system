# โ ุญู ูุดููุฉ "Invalid JWT" - ุงูุฌูุณุฉ ุงูููุชููุฉ

## ๐ ุงููุดููุฉ

```
โ [Dashboard] Error response: {
  "code": 401,
  "message": "Invalid JWT"
}
```

### ุงูุณุจุจ:
ุงูู **JWT Token** (access_token) ุงููุญููุธ ูู localStorage **ููุชูู ุงูุตูุงุญูุฉ** ุฃู **ุบูุฑ ุตุงูุญ**.

---

## ๐ ููุงุฐุง ูุญุฏุซ ูุฐุงุ

### 1๏ธโฃ ุงูุชูุงุก ุตูุงุญูุฉ ุงูู Token
- Supabase Auth ูุตุฏุฑ tokens ุจูุฏุฉ ุตูุงุญูุฉ ูุญุฏูุฏุฉ (ุนุงุฏุฉ ุณุงุนุฉ ูุงุญุฏุฉ)
- ุจุนุฏ ุงูุชูุงุก ุงููุฏุฉุ ูุตุจุญ ุงูู token ุบูุฑ ุตุงูุญ
- ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู

### 2๏ธโฃ Token ุชุงูู
- ุฅุฐุง ุชู ุชุนุฏูู ุงูู token ูุฏููุงู ูู localStorage
- ุฅุฐุง ูุงู ููุงู ุฎุทุฃ ุนูุฏ ุญูุธ ุงูู token

### 3๏ธโฃ ูุณุญ ุงูุจูุงูุงุช ูู Backend
- ุฅุฐุง ุชู ุญุฐู ุงููุณุชุฎุฏู ูู Auth
- ุฅุฐุง ุชู ูุณุญ ุงูู mapping ูู KV store

---

## โ ุงูุญู ุงููุทุจู

### 1๏ธโฃ ูุญุต ุชููุงุฆู ููู Token

ุชู ุฅุถุงูุฉ ูุญุต ูู `StudentDashboard.tsx`:

```typescript
// โ ุฅุฐุง ูุงู ุงูู token ููุชูู ุงูุตูุงุญูุฉ (401)
if (response.status === 401) {
  console.warn('โ๏ธ [Dashboard] Token expired or invalid, logging out...');
  
  // ูุณุญ ุงูุจูุงูุงุช ุงููุญููุฉ
  localStorage.removeItem('access_token');
  localStorage.removeItem('userInfo');
  localStorage.removeItem('isLoggedIn');
  
  toast.error(
    language === 'ar'
      ? 'ุงูุชูุช ุตูุงุญูุฉ ุงูุฌูุณุฉุ ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู'
      : 'Session expired, please login again'
  );
  
  // ุฅุนุงุฏุฉ ุงูุชูุฌูู ูุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู
  setTimeout(() => {
    window.location.reload();
  }, 2000);
  
  setLoading(false);
  return;
}
```

**ุงููุงุฆุฏุฉ:**
- โ ุงูุชุดุงู ุชููุงุฆู ููู token ุงูููุชูู
- โ ูุณุญ ุงูุจูุงูุงุช ุงููุญููุฉ
- โ ุฑุณุงูุฉ ูุงุถุญุฉ ูููุณุชุฎุฏู
- โ ุฅุนุงุฏุฉ ุชูุฌูู ุชููุงุฆูุฉ ููุตูุญุฉ ุงูุฑุฆูุณูุฉ

---

### 2๏ธโฃ ุฅูุดุงุก Auth Utilities

ุชู ุฅูุดุงุก ููู `/utils/auth.ts` ูุน ุฏูุงู ูุณุงุนุฏุฉ:

```typescript
/**
 * ูุญุต ุตูุงุญูุฉ ุงูู access token
 */
export async function isTokenValid(): Promise<boolean>

/**
 * ุชุณุฌูู ุฎุฑูุฌ ุงููุณุชุฎุฏู ููุณุญ ุฌููุน ุงูุจูุงูุงุช
 */
export function logout(): void

/**
 * ูุญุต ุตูุงุญูุฉ ุงูุฌูุณุฉ ูุชุณุฌูู ุฎุฑูุฌ ุชููุงุฆู
 */
export async function validateSessionOrLogout(): Promise<boolean>
```

**ุงูุงุณุชุฎุฏุงู:**
```typescript
import { validateSessionOrLogout } from '../utils/auth';

// ูู ุฃู component
const sessionValid = await validateSessionOrLogout();
if (!sessionValid) {
  // ุงูุฌูุณุฉ ููุชููุฉุ ุชู ุชุณุฌูู ุงูุฎุฑูุฌ ุชููุงุฆูุงู
  return;
}
```

---

## ๐งช ููููุฉ ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ 1: ูุญุงูุงุฉ Token ููุชูู

**ุงูุฎุทูุงุช:**
1. ุงูุชุญ Console (F12)
2. ุงูุชุจ:
   ```javascript
   localStorage.setItem('access_token', 'invalid_or_expired_token');
   ```
3. ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ ุฃู ุงุฐูุจ ุฅูู Dashboard

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
Console Logs:
  ๐ [Dashboard] Fetching registrations...
  ๐ [Dashboard] Using access token: invalid_or_expired_...
  ๐ก [Dashboard] Response status: 401
  โ๏ธ [Dashboard] Token expired or invalid, logging out...

Toast Notification:
  โ๏ธ "ุงูุชูุช ุตูุงุญูุฉ ุงูุฌูุณุฉุ ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู"

Action:
  ๐ ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ุจุนุฏ ุซุงููุชูู
  ๐ ุงูุนูุฏุฉ ูุตูุญุฉ Home (ุบูุฑ ูุณุฌู ุฏุฎูู)
```

---

### ุงุฎุชุจุงุฑ 2: ุชุณุฌูู ุฏุฎูู ุฌุฏูุฏ

**ุงูุฎุทูุงุช:**
1. ุจุนุฏ ุงูุชูุงุก ุงูุฌูุณุฉ
2. ุงุฐูุจ ุฅูู ุตูุญุฉ Login
3. ุณุฌู ุฏุฎูู ูุฑุฉ ุฃุฎุฑู
4. ุงุฐูุจ ุฅูู Dashboard

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
โ ุชุณุฌูู ุฏุฎูู ูุงุฌุญ
โ Token ุฌุฏูุฏ ุตุงูุญ
โ Dashboard ูุนูู ุจุดูู ุทุจูุนู
โ ุงูุจูุงูุงุช ุชูุญููู ุจูุฌุงุญ
```

---

## ๐ง ุงูุญู ุงูุฏุงุฆู (ูููุณุชุฎุฏููู)

### ุฅุฐุง ุธูุฑุช ุฑุณุงูุฉ "ุงูุชูุช ุตูุงุญูุฉ ุงูุฌูุณุฉ":

#### ุงูุฎุทูุฉ 1: ูุง ุชููู
- โ ูุฐุง ุทุจูุนู ุชูุงูุงู
- โ ุงููุธุงู ูุญูู ุฃูุงูู
- โ ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู ูุญู ุงููุดููุฉ

#### ุงูุฎุทูุฉ 2: ุณุฌู ุฏุฎูู ูุฑุฉ ุฃุฎุฑู
1. ุงุฐูุจ ุฅูู ุตูุญุฉ "ุชุณุฌูู ุงูุฏุฎูู"
2. ุฃุฏุฎู:
   - ุงูุฑูู ุงูุฌุงูุนู ุฃู ุงูุจุฑูุฏ
   - ูููุฉ ุงููุฑูุฑ
3. ุงุถุบุท "ุชุณุฌูู ุงูุฏุฎูู"

#### ุงูุฎุทูุฉ 3: ุงุณุชูุฑ ูู ุงุณุชุฎุฏุงู ุงููุธุงู
- โ ุงูุฌูุณุฉ ุงูุฌุฏูุฏุฉ ุตุงูุญุฉ
- โ ููููู ุงุณุชุฎุฏุงู ุฌููุน ุงูููุฒุงุช
- โ ุงูุจูุงูุงุช ูุญููุธุฉ

---

## ๐ก๏ธ ูุตุงุฆุญ ูุชุฌูุจ ุงูุชูุงุก ุงูุฌูุณุฉ

### 1๏ธโฃ ูุง ุชุบูู ุงููุชุตูุญ ูุฌุฃุฉ
- ุงุญูุธ ุนููู ูุจู ุงูุฅุบูุงู
- ุณุฌู ุฎุฑูุฌ ุจุดูู ุตุญูุญ

### 2๏ธโฃ ูุง ุชุนุฏู localStorage ูุฏููุงู
- โ ูุง ุชูุณุญ access_token
- โ ูุง ุชุนุฏู ุงูููู ูุฏููุงู
- โ ุงุณุชุฎุฏู ุฒุฑ "ุชุณุฌูู ุงูุฎุฑูุฌ"

### 3๏ธโฃ ุณุฌู ุฏุฎูู ุนูุฏ ุงูุญุงุฌุฉ
- ุฅุฐุง ูู ุชุณุชุฎุฏู ุงููุธุงู ููุฏุฉ ุทูููุฉ
- ุณุฌู ุฏุฎูู ูุฑุฉ ุฃุฎุฑู ูุจู ุงูุจุฏุก

---

## ๐ ูุนูููุงุช ุชูููุฉ (ูููุทูุฑูู)

### ุฏูุฑุฉ ุญูุงุฉ ุงูู JWT Token

```
1. Login โ Supabase Auth ูุตุฏุฑ Token ุฌุฏูุฏ
2. Token ุตุงูุญ ููุฏุฉ ุณุงุนุฉ ูุงุญุฏุฉ (3600 ุซุงููุฉ)
3. ุจุนุฏ ุณุงุนุฉ โ Token ููุชูู
4. ุฃู ุทูุจ ุจุนุฏูุง โ 401 Unauthorized
5. ูุฌุจ Login ูุฑุฉ ุฃุฎุฑู โ Token ุฌุฏูุฏ
```

### Token Structure

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "...",
  "expires_in": 3600,
  "token_type": "bearer"
}
```

### Token Validation

Backend ูุชุญูู ูู Token ุนุจุฑ:
```typescript
const { data: { user }, error } = await supabase.auth.getUser(accessToken);
if (error || !user) {
  return c.json({ error: 'Unauthorized' }, 401);
}
```

---

## ๐ฏ ุงูุชุญุณููุงุช ุงููุณุชูุจููุฉ (ุงุฎุชูุงุฑู)

### 1๏ธโฃ Refresh Token Automatically

ุญุงููุงู: ุนูุฏ ุงูุชูุงุก Token โ Logout  
ูุณุชูุจูุงู: ุงุณุชุฎุฏุงู refresh_token ูุชุฌุฏูุฏ Token ุชููุงุฆูุงู

```typescript
// ูุซุงู (ูู ููุทุจู ุจุนุฏ)
async function refreshToken() {
  const refreshToken = localStorage.getItem('refresh_token');
  const { data, error } = await supabase.auth.refreshSession({
    refresh_token: refreshToken
  });
  
  if (!error) {
    localStorage.setItem('access_token', data.session.access_token);
    return true;
  }
  return false;
}
```

### 2๏ธโฃ Session Timeout Warning

ุญุงููุงู: ูุง ููุฌุฏ ุชุญุฐูุฑ  
ูุณุชูุจูุงู: ุชุญุฐูุฑ ุงููุณุชุฎุฏู ูุจู 5 ุฏูุงุฆู ูู ุงูุชูุงุก ุงูุฌูุณุฉ

```typescript
// ูุซุงู (ูู ููุทุจู ุจุนุฏ)
function checkSessionExpiry() {
  const expiresAt = localStorage.getItem('expires_at');
  const now = Date.now();
  const timeLeft = expiresAt - now;
  
  if (timeLeft < 5 * 60 * 1000) { // 5 ุฏูุงุฆู
    toast.warning('ุณุชูุชูู ุฌูุณุชู ุฎูุงู 5 ุฏูุงุฆู');
  }
}
```

### 3๏ธโฃ Keep Session Alive

ุญุงููุงู: ูุง ููุฌุฏ  
ูุณุชูุจูุงู: ุฅุฑุณุงู ping ูู 30 ุฏูููุฉ ููุญูุงุธ ุนูู ุงูุฌูุณุฉ

---

## โ ุงูุฎูุงุตุฉ

### ุงููุดููุฉ:
โ Invalid JWT โ Token ููุชูู

### ุงูุญู ุงููุทุจู:
โ ูุญุต ุชููุงุฆู ููู token  
โ ุฑุณุงูุฉ ูุงุถุญุฉ ูููุณุชุฎุฏู  
โ ุชุณุฌูู ุฎุฑูุฌ ุชููุงุฆู  
โ ุฅุนุงุฏุฉ ุชูุฌูู ููุตูุญุฉ ุงูุฑุฆูุณูุฉ  

### ุงูุญู ูููุณุชุฎุฏู:
1๏ธโฃ ูุฑุฃ ุฑุณุงูุฉ "ุงูุชูุช ุตูุงุญูุฉ ุงูุฌูุณุฉ"  
2๏ธโฃ ุงุฐูุจ ูุตูุญุฉ Login  
3๏ธโฃ ุณุฌู ุฏุฎูู ูุฑุฉ ุฃุฎุฑู  
4๏ธโฃ ุงุณุชูุฑ ูู ุงุณุชุฎุฏุงู ุงููุธุงู  

**ุงููุดููุฉ ูุญูููุฉ! ๐**

---

## ๐ ููุงุญุธุฉ ูููุฉ

**ูุฐุง ููุณ ุฎุทุฃ (Bug)ุ ุจู ููุฒุฉ ุฃูุงู!**

- โ ุงูุชูุงุก ุงูุฌูุณุงุช ูุญูู ุญุณุงุจู
- โ ูููุน ุงุณุชุฎุฏุงู Token ูุฏูู
- โ ูุถูู ุฃู ุงููุณุชุฎุฏู ุงูุญุงูู ูู ุตุงุญุจ ุงูุญุณุงุจ ุงููุนูู

**ุงููุธุงู ูุนูู ููุง ูู ูุตูู! ๐โจ**
