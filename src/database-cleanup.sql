-- =====================================================
-- ๐งน ุณูุฑูุจุช ุชูุธูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
-- ูุธุงู ุชุณุฌูู ุงูููุฑุฑุงุช - ุฌุงูุนุฉ ุงูููู ุฎุงูุฏ
-- =====================================================

-- โ๏ธ ุชุญุฐูุฑ: ูุฐุง ุงูุณูุฑูุจุช ุณูุญุฐู ุงูุจูุงูุงุช ุบูุฑ ุงูุตุญูุญุฉ
-- ุชุฃูุฏ ูู ุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุจู ุงูุชุดุบูู

-- =====================================================
-- 1๏ธโฃ ุนุฑุถ ุงูุญุณุงุจุงุช ุงููุนุทูุจุฉ (ูููุญุต ููุท)
-- =====================================================

-- โ ุนุฑุถ ุงูุทูุงุจ ุจุฏูู ุจูุงูุงุช ูุงููุฉ
SELECT 
  u.id,
  u.student_id,
  u.email,
  u.name,
  u.role,
  s.major,
  s.level,
  s.gpa,
  u.created_at
FROM users u
LEFT JOIN students s ON u.id = s.user_id
WHERE u.role = 'student' 
  AND (
    s.id IS NULL  -- ูุง ููุฌุฏ ุณุฌู ูู ุฌุฏูู students
    OR s.major IS NULL 
    OR s.level IS NULL
  )
ORDER BY u.created_at DESC;

-- =====================================================
-- 2๏ธโฃ ุญุฐู ุงูุทูุงุจ ุจุฏูู ุจูุงูุงุช ูุงููุฉ
-- =====================================================

-- โ๏ธ ูู ุจุฅุฒุงูุฉ ุงูุชุนููู ูุชุดุบูู ุงูุญุฐู (ุญุฐู ุงูุณุทุฑูู -- ูู ุงูุจุฏุงูุฉ)

-- ุญุฐู ูู ุฌุฏูู students ุฃููุงู (ุฅุฐุง ูุงู ููุฌูุฏ)
-- DELETE FROM students 
-- WHERE user_id IN (
--   SELECT u.id 
--   FROM users u
--   LEFT JOIN students s ON u.id = s.user_id
--   WHERE u.role = 'student' 
--     AND (s.id IS NULL OR s.major IS NULL OR s.level IS NULL)
-- );

-- ุญุฐู ูู ุฌุฏูู users
-- DELETE FROM users 
-- WHERE role = 'student' 
--   AND id IN (
--     SELECT u.id 
--     FROM users u
--     LEFT JOIN students s ON u.id = s.user_id
--     WHERE u.role = 'student' 
--       AND (s.id IS NULL OR s.major IS NULL OR s.level IS NULL)
--   );

-- ููุงุญุธุฉ: ุญุฐู ุงููุณุชุฎุฏู ูู Auth ูุฌุจ ุฃู ูุชู ุนุจุฑ Supabase Auth Admin API
-- ูุง ูููู ุญุฐูู ุนุจุฑ SQL ูุจุงุดุฑุฉ

-- =====================================================
-- 3๏ธโฃ ุนุฑุถ ุฅุญุตุงุฆูุงุช ุงููุธุงู
-- =====================================================

-- ุนุฏุฏ ุงููุณุชุฎุฏููู ุญุณุจ ุงูุฏูุฑ
SELECT 
  role,
  COUNT(*) as count
FROM users
GROUP BY role
ORDER BY count DESC;

-- ุนุฏุฏ ุงูุทูุงุจ ูุน ุจูุงูุงุช ูุงููุฉ
SELECT 
  COUNT(*) as students_with_complete_data
FROM users u
INNER JOIN students s ON u.id = s.user_id
WHERE u.role = 'student' 
  AND s.major IS NOT NULL 
  AND s.level IS NOT NULL;

-- ุนุฏุฏ ุงูุทูุงุจ ูุน ุจูุงูุงุช ูุงูุตุฉ
SELECT 
  COUNT(*) as students_with_incomplete_data
FROM users u
LEFT JOIN students s ON u.id = s.user_id
WHERE u.role = 'student' 
  AND (s.id IS NULL OR s.major IS NULL OR s.level IS NULL);

-- =====================================================
-- 4๏ธโฃ ุงูุชุญูู ูู ุณูุงูุฉ ุงูุจูุงูุงุช
-- =====================================================

-- ุงูุชุญูู ูู ูุฌูุฏ ูุณุชุฎุฏููู ุจุฏูู ุณุฌู ูู ุฌุฏูู ุงูุฏูุฑ ุงูููุงุณุจ
SELECT 
  u.id,
  u.student_id,
  u.email,
  u.role,
  CASE 
    WHEN u.role = 'student' AND s.id IS NULL THEN 'โ Missing student record'
    WHEN u.role = 'supervisor' AND sup.id IS NULL THEN 'โ Missing supervisor record'
    ELSE 'โ OK'
  END as status
FROM users u
LEFT JOIN students s ON u.id = s.user_id AND u.role = 'student'
LEFT JOIN supervisors sup ON u.id = sup.user_id AND u.role = 'supervisor'
WHERE 
  (u.role = 'student' AND s.id IS NULL)
  OR (u.role = 'supervisor' AND sup.id IS NULL);

-- =====================================================
-- 5๏ธโฃ ุฅุตูุงุญ ุงูุจูุงูุงุช (ุงุฎุชูุงุฑู)
-- =====================================================

-- ุฅุฐุง ููุช ุชุฑูุฏ ุฅุตูุงุญ ุจูุงูุงุช ุทุงูุจ ูุนูู ุจุฏูุงู ูู ุญุฐูู:

-- ูุซุงู: ุชุญุฏูุซ ุจูุงูุงุช ุทุงูุจ ูุนูู
-- UPDATE students 
-- SET 
--   major = 'ูุธู ุงููุนูููุงุช ุงูุฅุฏุงุฑูุฉ',
--   level = 1,
--   gpa = 0.0
-- WHERE user_id = (SELECT id FROM users WHERE email = 'student@kku.edu.sa');

-- =====================================================
-- 6๏ธโฃ ูุตุงุฆุญ ููุตูุงูุฉ
-- =====================================================

/*
โ ูุตุงุฆุญ ูููุฉ:

1. **ูุจู ุงูุญุฐู:**
   - ุดุบูู ุงูุงุณุชุนูุงูุงุช ูู ุงููุณู 1 ูููุญุต
   - ุชุฃูุฏ ูู ุฃู ุงูุญุณุงุจุงุช ุงููุนุทูุจุฉ ูู ูุนูุงู ุญุณุงุจุงุช ุชุฌุฑูุจูุฉ

2. **ุจุนุฏ ุงูุญุฐู:**
   - ุดุบูู ุงุณุชุนูุงูุงุช ุงููุณู 3 ููุชุญูู ูู ุงูุฅุญุตุงุฆูุงุช
   - ุชุฃูุฏ ูู ุนุฏู ุญุฐู ุญุณุงุจุงุช ูููุฉ

3. **ููููุงูุฉ:**
   - ุงุณุชุฎุฏู ุงููุธุงู ุงููุญุฏูุซ ุงูุฐู ูููุน ุฅูุดุงุก ุญุณุงุจุงุช ูุนุทูุจุฉ
   - ุฑุงุฌุน ููุฏ Backend ุจุงูุชุธุงู
   - ูุนูู Validation ูู ุงูู Frontend

4. **Auth Cleanup:**
   - ูุญุฐู ุงููุณุชุฎุฏููู ูู Supabase Authุ ุงุณุชุฎุฏู ุฃุฏุงุฉ ุงูุชูุธูู ูู ุงููุธุงู
   - ุฃู ุงุณุชุฎุฏู Supabase Dashboard > Authentication > Users
*/

-- =====================================================
-- ๐ ุชู ุฅูุดุงุคู ููุดุฑูุน ุงูุชุฎุฑุฌ
-- ุฌุงูุนุฉ ุงูููู ุฎุงูุฏ - ูููุฉ ุฅุฏุงุฑุฉ ุงูุฃุนูุงู
-- ูุณู ูุธู ุงููุนูููุงุช ุงูุฅุฏุงุฑูุฉ
-- ุฅุดุฑุงู: ุฏ. ูุญูุฏ ุฑุดูุฏ
-- =====================================================
