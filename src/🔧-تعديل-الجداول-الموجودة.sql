-- ======================================
-- ๐ง ุชุนุฏูู ุงูุฌุฏุงูู ุงูููุฌูุฏุฉ ูู Supabase
-- ======================================

-- โ๏ธ ุงุณุชุฎุฏู ูุฐุง ุงูููู ุฅุฐุง ูุงูุช ุงูุฌุฏุงูู ููุฌูุฏุฉ ุจุงููุนู
-- ุฅุฐุง ููุช ุชูุดุฆ ุงูุฌุฏุงูู ูุฃูู ูุฑุฉุ ุงุณุชุฎุฏู: ๐-ุฅูุดุงุก-ุงูุฌุฏุงูู-ูู-Supabase.sql

-- ========================================
-- 1๏ธโฃ ุชุนุฏูู ุฌุฏูู users - ุฌุนู student_id nullable
-- ========================================

-- ุฅุฒุงูุฉ ุงูููุฏ NOT NULL ูู student_id
ALTER TABLE users 
  ALTER COLUMN student_id DROP NOT NULL;

-- ุชุญุฏูุซ Index (ุฅุฐุง ูุฒู ุงูุฃูุฑ)
DROP INDEX IF EXISTS idx_users_student_id;
CREATE INDEX idx_users_student_id ON users(student_id) WHERE student_id IS NOT NULL;

-- ========================================
-- 2๏ธโฃ ุชุญุฏูุซ ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ (ุงุฎุชูุงุฑู)
-- ========================================

-- ุชุนููู student_id = NULL ูููุณุชุฎุฏููู ุบูุฑ ุงูุทูุงุจ
UPDATE users 
SET student_id = NULL 
WHERE role IN ('supervisor', 'admin') 
  AND student_id IS NOT NULL;

-- ========================================
-- 3๏ธโฃ ุงูุชุญูู ูู ุงููุฌุงุญ
-- ========================================

-- ุนุฑุถ ุงููุณุชุฎุฏููู
SELECT 
  id,
  email,
  name,
  student_id,
  role,
  created_at
FROM users
ORDER BY created_at DESC
LIMIT 10;

-- ุนุฑุถ ุฅุญุตุงุฆูุงุช
SELECT 
  role,
  COUNT(*) as count,
  COUNT(student_id) as with_student_id
FROM users
GROUP BY role;

-- ========================================
-- โ ุชู ุงูุชุนุฏูู ุจูุฌุงุญ!
-- ========================================

SELECT 'โ ุชู ุชุนุฏูู ุฌุฏูู users ุจูุฌุงุญ! ุงูุขู ูููู ุฅูุดุงุก ุญุณุงุจุงุช ูููุดุฑููู ูุงูุฅุฏุงุฑููู ุจุฏูู student_id' as message;
